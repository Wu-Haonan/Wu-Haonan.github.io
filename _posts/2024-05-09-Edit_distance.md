---
layout: article
title: Non-Linear Time Edit Distance for Indel Channels
tags: papers

---

In this blog, we will check out a theoretical paper about edit distance. In fact edit distance is a kernel idea for sequence alignment in bioinformatics. There are many available tools developed to solve various kinds of alignment scenario. While there exists a gap between theoretical algorithms and practical tools. In practice, we also embed some heuristic part to the tools to facilitate alignment. As theoreticians, they need to figure out some techniques to get a theoretical analysis of these tools that is more close to the practical performance. Further, a good theoretical analysis will light the direction of improvement. 

This paper proposed a framework based on the classic NW algorithm with running time $\mathcal{O}(n\lg n)$ in average, which is also adapted by many classic implements, like BLAST. Hence, the analysis of the algorithm mentioned in this paper is also a theoretical justification of these heuristic-based alignment tools. 

<!--more-->

# Motivation and Background

# Sketch of algorithm

# Preliminaries and Definitions

## Problem Setup

Given a uniformly random bitstring ${s_1 \sim \\{0,1\\}^n}$. We generate $s_2$ by $s_1$ via indel channel. For the $j$th bit of $s_1$, $b_j:=(s_1)_j$:

- $b_j$ is substituted i.e. flip, with probability $p_s$. 

- $b_j$ is deleted with probability 

  - $p_d$ if the previous bit $b_{j-1}$ was not deleted;

  - $q_d$ ($>p_d$) if the previous bit $b_{j-1}$ was deleted;
  
- An insertion event occurs with probability $p_i$, inserting a uniformly random bit string ${t \sim \\{0,1\\}^I}$ with length $I \sim \text{Geo}(1-q_i)$ to the right of $b_j$. Inserted bits are not further acted upon by the indel channel. (here the probability of geometric distribution $\Pr(I=k)=(q_i)^{k-1}(1-q_i)$, we can set a unfair coin and the number of times we first get a "head" is $I$).

Each operation is call an **edit**, and use $\mathcal{E}$ to denote the set of edits generated in the indel channel. Each mutation independently happens for each bit and across different bits. We assume 
$$
\begin{equation}
p_s \leq \rho_s, \quad p_d \leq \rho_d,\frac{1-\rho_d}{1-q_d} \leq \rho_d', \quad p_i \leq \rho_i, \frac{1}{1-q_i} \leq \rho_i'
\end{equation}
$$
are hold for some small constants ${\\{\rho\\}:=\\{\rho_s,\rho_d,\rho_d',\rho_i,\rho_i'\\}}$. We denote the distribution of tuples $(s_1,s_2,\mathcal{E})$ as $ID(n)$, i.e. $(s_1,s_2,\mathcal{E}) \sim ID(n)$ generated by some probability $p,q$. Given $(s_1,s_2,\mathcal{E}) \sim ID(n)$, then we can compute edit distance $ED(s_1,s_2)$. Formally, this paper proposes following main theorem. 

**Theorem 2.** Assuming $(1)$ holds for certain constants ${\\{\rho\\}}$, there exists a (deterministic) algorithm running in time $\mathcal{O}(n \ln n)$ that computes $ED(s_1,s_2)$ for $(s_1,s_2,\mathcal{E}) \sim ID(n)$ with probability $1-n^{-\Omega(1)}$. 

## Preparation and Lemma

We denote the number of ways to split $a+b+c$ into three groups of size $a,b,c$ i.e. trinomial by $\binom{a+b+c}{a,b,c} = \binom{a+b+c}{a} \binom{b+c}{b}= \frac{(a+b+c)!}{a!(b+c)!} \cdot \frac{(b+c)!}{b!c!} = \frac{a+b+c}{a!b!c!}$.



**Fact 4** (Chernoff Bound). Let $X_1 \cdots X_n$ be independent Bernoulli random variables and $X=\sum_{i=1}^n X_i, \mu = \mathbb{E}[X]$. Then for $0 < \epsilon <1$:
$$
\Pr[X\geq (1+\epsilon)\mu] \leq e^{-\frac{\epsilon^2\mu}{3}},\quad \Pr[X\leq (1-\epsilon)\mu] \leq e^{-\frac{\epsilon^2\mu}{2}},
$$


Consider the insertion process, the number of times $m$ for insertion for whole bitstring is a Binomial distribution with probability $p_i$, and the number of insertion bits is a negative binomial distribution with $m$ and probability $q_i$. (This process like that fliping an unfair coin and getting $m$ heads). So, we bound the process in following lemmas.



**Fact 5** (Negative binomial tail bound). Let $X\sim NBinom(m,q)$, then
$$
\Pr[X \geq k n /p] \leq e^{-\frac{kn(1-1/k)^2}{2}}
$$
**Proof.** If we need more than $kn/p$ times to get $n$ success events, that means when we flip $kn/p$ times, the total number $Y$ of success events is less than $n$, i.e.

$$
\Pr[X \geq k n /p] = \Pr[Binom(kn/p,p)<n]
$$

Then, we can apply Chernoff bound, get the bound 

$$
\Pr[Y < n] = \Pr[Y < (1 - (1- 1/k)) kn] \leq e^{-\frac{kn(1-1/k)^2}{2}}
$$

Proof done.  $\square$



**Lemma 6.** Consider $X\sim NBinom(m,q)$, where $m=\sum_{i=1}^t m_i, m_i \sim Bern(p_i)$. Then for $1< \alpha \leq 4, \mu=\sum_{i=1}^t p_i$:

$$
\Pr \left[X \geq \alpha \cdot \frac{\mu}{q}\right] \leq e^{-\frac{(\sqrt{\alpha}-1)^2\mu}{3}} +  e^{-\alpha\mu \frac{(1-1/\sqrt{\alpha})^2}{2}}
$$

## Definitions

**Definition 7.** Consider the **dependency graph** of the edit distance dynamic programming table. The **edit distance** between $s_1,s_2$ denoted as $ED(s_1,s_2)$ is the weighted shortest path from $(0,0)$ to $(n_1,n_2)$. 



**Fact 8.** (Needleman–Wunsch algorithm): Edit distance between $s_1,s_2$ of length $n_1,n_2$ can be computed in $\mathcal{O}(\vert V \vert + \vert E\vert )$ time by dynamic programming. If we know the dependency graph is contained in vertex set $V'$, we can compute edit distance in $\mathcal{O}(\vert V' \vert)$ time by deleting $V \setminus V'$ in dependency graph. 



**Definition 9.** An **alignment** of two string $s_1,s_2$ is any path ${A=\\{(i_1=0,j_1=0),(i_2,j_2),\cdots,(i_L=n_1,j_L=n_2)\\}}$ from from $(0,0)$ to $(n_1,n_2)$. The set of all alignments is denoted as $\mathcal{A}$.



**Definition 10.** For $(s_1,s_2,\mathcal{E}) \sim ID(n)$, the **canonical alignment** of $s_1,s_2$, denoted $A^*$, is the alignment corresponding to $\mathcal{E}$. (We chose each edge/path in dependency graph based on each edit in $\mathcal{E}$). 



We should notice that the optimal alignment could not be canonical alignment. For alignments which aren't the canonical alignment, we characterize their differences from the canonical alignment in the following way.



**Definition 11.** Fix a canonical alignment $A^\*$, and let $A$ be any alignment. A **break** of $A$ (from $A^\*$) is any subpath ${\\{(i_1,j_1),(i_2,j_2)\cdots(i_L,j_L)\\}}$ of $A$ such that $(i_1,j_1),(i_L,j_L)$ are in $A^\*$ but none of $(i_2,j_2)$ to $(i_{L-1},j_{L-1})$ are in $A^*$. The length of break is the value $i_L-i_1$. 

​        For $(s_1,s_2,\mathcal{E}) \sim ID(n)$, a break is **long** if its length is at least $k \ln n$ and **short** otherwise. An alignment is **good** if it has no long breaks and **bad** if it has at least one long break**.**



**Definition 12.** (Short and Long Break Replacement). We define $\mathcal{SBR}:\mathcal{A}\mapsto \mathcal{A}$ as a function such that for any alignment $A$, $\mathcal{SBR}(A)$ is the alignment arrived at by applying the following modification to all short breaks in $A$: For a short break from $(i_1,j_1)$ to $(i_L,j_L)$, replace it with the subpath of $A^*$ from $(i_1,j_1)$ to $(i_L,j_L)$. We define $\mathcal{LBR}$ analogously. 

# Substitution-Only Case

First, let's consider the simplest case, we only consider substitution here and canonical alignment $A^*$ is just the diagonal ${\\{(0,0),(1,1) \cdots (n,n)\\}}$. We will show following theorem

**Theorem 13.** For $(s_1,s_2,\mathcal{E}) \sim ID(n)$ with $p_i,p_d=0$, suppose $p_s \leq \rho_s$, where $\rho_s = 0.028$, there is  an $\mathcal{O}(n\ln n)$ time algorithm for computing $ED(s_1,s_2)$ which is correct with probability $1- n^{-\Omega(1)}$. 

**Proof sketch:** 

1. **Algorithm:** Call canonical DP on the dependency graph, which is deleted each entry $(i,j)$ s.t. $\vert i-j\vert > k \ln n$. 
2. "**Off-diagonal**" alignment $A$ (sharing no edge with $A^*$)  is greater than $A^*$ with high probability (shown in Lemma 14).
3. **Lemma 17** (proved through Lemma 14) tells us with high probability, all the alignments in the range of $\mathcal{SBR}$ satisfy $A \geq A^*$. Then, if this condition holds, the lowest-cost good alignment is also the best alignment in whole DP. So, even we only consider the best alignment on trimmer dependency graph, we can still get best alignment on global one.     $\square$



# Finding an Approximate Alignment

We know consider the case where insertions and deletions are all present. 

**Definition 18.** Given an alignment $A$, $f_A:[n] \rightarrow \mathbb{Z}$ be the function such that for all $i \in [n]$, $(i,f_A(i)$ is the first vertex in $A$ of the form $(i,j)$. 

## Properties of the Indel Channel

To simplify presentation, let $\kappa_n = \rho_i \rho_i' + (\rho_d + 1/k \ln n)(\rho_d' +1)$.

**Lemma 19.** For $(s_1,s_2,\mathcal{E}) \sim ID(n)$, let $s_1'$ be the substring formed by bits $i$ to $i+k\ln n -1$ of string $s_1$, and $s_2$ be the substring formed by bits $f_{A^*}(i)$ to $f_{A^*}(i+k \ln n)-1$ of $s_2$. Then:

$$
\Pr_{(s_1,s-2,\mathcal{E})\sim ID(n)} \left[ED(s_1',s_2') \geq \frac{3}{2} (\rho_s + \kappa_n) k \ln n \right] \leq n^{-\rho_s k /12} + 2n^{-\rho_i k /60} + 3n^{-\rho_d k /60}
$$

**Proof.** We calculate the upper bound of edit distance by take the union bound of three types of mutation. 

1. **Substitution**: the expectation is at most $\rho_s k \ln n$. Each substitution is a Bernoulli experiment,  so we can calculate the Chernoff bound, $\Pr[\text{Substitution}\geq \frac{3}{2}\rho_s k \ln n]] \leq e^{-\rho_s k \ln n /12} \leq n ^{-\rho_s k/12}$.

2. **Insertion**: the number of insertion is $p_i \frac{1}{1-q_i} k \ln n$ in expectation, and at most $\rho_i \rho_i' k \ln n$. With $\alpha=3/2$, we can apply lemma 6 to get the bound of $NBinom(Binom(k \ln n, \rho_i), 1/ \rho_i')$ is at most $2n ^{-\rho_ik/60}$.

3. **Deletion**: we consider a slightly different process here to simplify analysis
   - For each bit of “type 1” deletion, the probability is $p_d$. But for the first bit of substring, we don't know if there has deletion before, so we set probability $q_d$ for bit $1$.
   
   - If bit $j$ has a type 1 deletion, then we sample $\delta\sim Geo(\frac{1-q_d}{1-p_d})$. Then $\Delta$ be the number of bits between $j$ and next bit with type $1$ deletion. A type 2 deletion occurs on the ${\min\\{\delta,\Delta\\}}$ bits after $j$. Why choose this distribution, because if bit $j-1$ takes type 1 deletion, the overall probability of bit $j$ takes deletion is 

     $$
     \Pr[\text{type 1}] + \Pr[\text{type 2} \mid \text{type 1 not taken}] = p_d + (1-p_d) \frac{q_d-p_d}{1-p_d} = q_d
     $$
     
     Hence, we set random variable $Y$ and $X$ for type $1$ and type $2$ deletion. Then $Y \sim Binom(k\ln n -1 ,p_d) + Bero(q_d)$, and $X \sim NBinom(Y,\frac{1-q_d}{1-p_d})$. Hence, the probability of $Y$ exceeds $\frac{3}{2}(\rho_d k \ln n)+1$ is at most $n^{-\rho_d k /12}$ by Chernoff bound. The probability of $X$ exceeds $\frac{3}{2}(\rho_d k \ln n +1)\rho_d'$ is bound by lemma 6, that is $2n ^{-\rho_d k/60}$. So, the total bound is $3n^{-\rho_d k /60}$.   $\square$
     
     

**Lemma 20.** Let $s_1,s_2$ be bitstrings of length $k\ln n$, chosen independently and uniformly at random from all bitstrings of length $k \ln n$. Then $\Pr[ED(s_1,s_2)\leq D]\leq \frac{(4e \frac{k \ln n}{D} + 5 e + \frac{4e}{D})^D}{2^{k \ln n}}$.



**Lemma 21.** For constant $k>0, i \leq n - k\ln n$,]$

$$
\Pr_{(s_1,s_2,\mathcal{E})\sim ID(n)} \left[ \vert  f_{A^*}(i+k \ln n) - f_{A^*}(i) - k \ln n \vert \leq \frac{3}{2} \kappa_n \cdot k \ln n\right] \geq 1- 2n^{-\rho_i k /60} - 3n^{-\rho_d k /60}
$$

**Proof.** $\vert  f_{A^\*}(i+k \ln n) - f_{A^\*}(i) - k \ln n \vert$ is the difference between the number of insertions and deletions in the range of $[i, i+ k\ln n -1]$ of $s_1$. So the upper bound is the union of the upper bound of insertion and deletion argued in Lemma 19. $\square$



<p align="center">
    <img src="/post_image/Edit_distance/Corallary_22.png" width="100%">
</p>





## Algorithm for Quickly Finding an Approximate Alignment



















  



